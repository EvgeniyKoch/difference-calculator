name: Node.js CI

on:
    push:
        branches:
            - master
        tags:
            - '!*' # Do not execute on tags
        paths:
            - src/*
            - test/*
            - '*.json'
            - package-lock.json
    pull_request:
        paths:
            - '!*.MD'

jobs:
    test:
        strategy:
            matrix:
                platform: [ macOS-latest ]
                node: [ '12', '10' ]
        name: test/node ${{ matrix.node }}/${{ matrix.platform }}
        runs-on: ${{ matrix.platform }}
        steps:
            -   uses: actions/checkout@master
            -   uses: actions/setup-node@master
                with:
                    node-version: ${{ matrix.node }}
            -   run: npm install -g yarn
            -   run: yarn install
            -   run: yarn build
            -   run: yarn test
        coverage:
            needs: [ test ]
            name: coverage
            runs-on: ubuntu-latest
            steps:
                -   uses: actions/checkout@master
                -   uses: actions/setup-node@master
                    with:
                        node-version: '12'
                -   run: npm install -g yarn
                -   run: yarn install
                -   run: yarn build
                -   uses: paambaati/codeclimate-action@v2.2.4
                    env:
                        CC_TEST_REPORTER_ID: e17f1d4fe4afb813a886f797aeb0078bd7d63c9c70e595c0d962db06d67a4628
                    with:
                        coverageCommand: yarn coverage
    build:

        runs-on: macOS-latest

        strategy:
            matrix:
                node-version: [8.x, 10.x, 12.x]

        steps:
            -   uses: actions/checkout@v2
            -   name: Use Node.js ${{ matrix.node-version }}
                uses: actions/setup-node@v1
                with:
                    node-version: ${{ matrix.node-version }}
            -   run: npm install
            -   run: npm run build --if-present
            -   run: npm test
                env:
                    CI: true
